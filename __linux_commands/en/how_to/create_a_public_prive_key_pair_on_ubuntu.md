* Draft: 2020-06-08 (Mon)

# Create a Public/Private Key Pair

## Summary

For details, refer to: [How To Set Up SSH Keys on Ubuntu 16.04](https://www.digitalocean.com/community/tutorials/how-to-set-up-ssh-keys-on-ubuntu-1604), 2018-04-12, Hanif Jetha

### Step 1 — Create the RSA Key Pair 

```bash
$ ssh-keygen
```

### Step 2 — Copy the Public Key to Ubuntu Server

#### Option 1. Copying Public Key Using `ssh-copy-id`

```bash
$ ssh-copy-id username@remote_host
```

You must already have password-based SSH access to your server.  On the remote host, specify the user account that you have password SSH access to. This is the account to which your public SSH key will be copied.

#### Option 2. Copying Public Key Using SSH

```bash
$ cat ~/.ssh/id_rsa.pub | ssh username@remote_host "mkdir -p ~/.ssh && touch ~/.ssh/authorized_keys && chmod -R go= ~/.ssh && cat >> ~/.ssh/authorized_keys"
```

#### Option 3. Copying Public Key Manually

```bash
# Local Machine
$ cat ~/.ssh/id_rsa.pub

# Remote-server
$ mkdir -p ~/.ssh
$ echo public_key_string >> ~/.ssh/authorized_keys
$ chmod -R go= ~/.ssh
$ chown -R sammy:sammy ~/.ssh
```

Manually append the content of your `id_rsa.pub` file to the `~/.ssh/authorized_keys` file on your remote machine.

### Step 3 — Authenticate to Ubuntu Server Using SSH Keys

```bash
$ ssh username@remote_host
```

### Step 4 — Disable Password Authentication on your Server

```bash
Disable `PasswordAuthentication` in `sshd_config`.
$ sudo nano /etc/ssh/sshd_config
```

> ```text
> ...
> PasswordAuthentication no
> ...
> ```

```bash
$ sudo systemctl restart ssh
```

Test if it works fine.

```bash
$ ssh username@remote_host
```

For more information, google-search `ubuntu how to create public private key pair`

## Hands-on

### Step 1-1. Create the RSA Key Pair 

The `ssh-keygen` creates both public and private keys.

```bash
$ hostname
local-machine
$ ssh-keygen
Generating public/private rsa key pair.
Enter file in which to save the key (/home/aimldl/.ssh/id_rsa): 
Created directory '/home/aimldl/.ssh'.
Enter passphrase (empty for no passphrase): 
Enter same passphrase again: 
Your identification has been saved in /home/aimldl/.ssh/id_rsa.
Your public key has been saved in /home/aimldl/.ssh/id_rsa.pub.
The key fingerprint is:
SHA256:8Brf6SU1oa4/+/ThbrvvLHlRO8XkIy1KqikaKoOJ/zM aimldl@GPU-Desktop
The key's randomart image is:
+---[RSA 2048]----+
|                 |
|                .|
|      .     . .+ |
|       o   o + o=|
|      . S + + o =|
|       + + + . + |
|o. .  . + = o ..o|
|* . E. o o.+ o+o.|
|.+.ooo. ..++.o*B+|
+----[SHA256]-----+
$
```

Note the user name on the local machine is set to be `aimldl`. The above SHA256 and randommart image are an example generated by `ssh-keygen`. 

Entering pas —sphrase is optional. I do not provide passphrase for convenience, though. If a private key is created with passphrase, the passphrase is asked when you attempt to access a remote host with the private key.

```bash
$ ssh git@123.456.7.890
Enter passphrase for key 'id_rsa': 
```

Note the user name on the remote host is set to be `git`. 

Back to the `ssh-keygen` command, a confirmation message will be shown if there exists an existing key pair. Be careful when you overwrite the key pairs because the existing key pairs will no longer be used.

```bash
/home/aimldl/.ssh/id_rsa already exists.
Overwrite (y/n)? y
```

Let's check the created key pairs.

```bash
$ ls ~/.ssh/
id_rsa  id_rsa.pub
$
```
* Public key: `id_rsa.pub`
```bash
ssh-rsa ...
  ... git@GPU-Desktop
```

* Private key: `id_rsa`
```bash
-----BEGIN RSA PRIVATE KEY-----
Proc-Type: 4,ENCRYPTED
DEK-Info: AES-128-CBC,  ...
  ...
-----END RSA PRIVATE KEY-----
```
### Step 1-2. Change the permission of the private key

```bash
$ chmod 400 id_rsa
```

Otherwise, the following warning occurs when this private key is used.

```bash
$ ssh git@123.456.7.890
@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@         WARNING: UNPROTECTED PRIVATE KEY FILE!          @
@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
Permissions 0644 for 'id_rsa' are too open.
It is required that your private key files are NOT accessible by others.
This private key will be ignored.
Load key "id_rsa": bad permissions
```

### Step 2. Copy the Public Key to Ubuntu Server

You must already have password-based SSH access to your server.  I have the remote host which works with password.

```bash
# On the local machine,
$ ssh git@123.456.7.890
git@123.456.7.890's password: 
Welcome to Ubuntu 18.04.2 LTS (GNU/Linux 4.15.0-99-generic x86_64)
  ...
Last login: Mon Jan 20 09:25:37 2020
2020-06-08 (월) 11:26 (23th week)
(base) git@GPU-Desktop:~$ 
```

#### Option 1. Copying Public Key Using `ssh-copy-id`

```bash
# On your local machine
$ ssh-copy-id username@remote_host
```

On the remote host, specify the user account that you have password SSH access to. This is the account to which your public SSH key will be copied. 

Run the `ssh-copy-id` command on your local machine.

```bash
$ hostname
local-machine
$ ssh-copy-id git@123.456.7.890
/usr/bin/ssh-copy-id: INFO: Source of key(s) to be installed: "/home/aimldl/.ssh/id_rsa.pub"
/usr/bin/ssh-copy-id: INFO: attempting to log in with the new key(s), to filter out any that are already installed
/usr/bin/ssh-copy-id: INFO: 1 key(s) remain to be installed -- if you are prompted now it is to install the new keys
git@123.456.7.890's password: 

Number of key(s) added: 1

Now try logging into the machine, with:   "ssh 'git@123.456.7.890'"
and check to make sure that only the key(s) you wanted were added.
$
```

Notice this command is to run on your local machine. If `ssh-copy-id` is ran on the remote host by accident, the following error message occurs.

```bash
$ ssh-copy-id git@123.456.7.890
The authenticity of host '123.456.7.890 (123.456.7.890)' can't be established.
ECDSA key fingerprint is SHA256:  ... .
Are you sure you want to continue connecting (yes/no)? ^C
/usr/bin/ssh-copy-id: WARNING: All keys were skipped because they already exist on the remote system.
		(if you think this is a mistake, you may want to use -f option)
$
```



### Step 3. Authenticate to Ubuntu Server Using SSH Keys

Test if you can log in without entering the password.

```bash
$ ssh git@123.456.7.890
Welcome to Ubuntu 18.04.2 LTS (GNU/Linux 4.15.0-99-generic x86_64)
  ...
$ hostname
remote-host
$
```

### Step 4. Disable Password Authentication on your Server

```bash
$ sudo nano /etc/ssh/sshd_config
```

Active configurations are below.

```txt
  ...
# To disable tunneled clear text passwords, change to no here!
#PasswordAuthentication yes
  ...
ChallengeResponseAuthentication no
UsePAM yes
X11Forwarding yes
PrintMotd no
AcceptEnv LANG LC_*
Subsystem       sftp    /usr/lib/openssh/sftp-server
```

Uncomment `PasswordAuthentication` and set it to `no`.

```bash
  ...
PasswordAuthentication no
  ...
```

Restart `ssh` to make the change effective and leave the remote host.

```bash
$ sudo systemctl restart ssh
$ exit
logout
Connection to 123.456.7.890 closed.
```

Log back in to ensure it works fine.

```bash
$ ssh git@123.456.7.890
```



### Troubleshooting

If `git` on the remote host is not in the sudoer's list, add `git` into the list. 

```bash
$ sudo nano /etc/ssh/sshd_config
[sudo] password for git: 
git is not in the sudoers file.  This incident will be reported.
$
```

On the remote host, I've switched another user account with sudoer's right and granted the right to `git`.

```bash
$ sudo adduser git sudo
[sudo] paaword for aimldl:
Adding user `git` to group `sudo` ...
Adding user git to group sudo
Done.
$
```

I refreshed the terminal and the command worked just fine.
